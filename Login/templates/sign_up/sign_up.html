{% extends "base/notification.html" %}
{% load static %}
{% block title %} Sign-up {% endblock title %}

{% block content %}
    <!-- Page Title -->
    <title>Saflora â€” Sign Up</title>

    <!-- Add Tailwind & Poppins Font -->
    <script src="https://cdn.tailwindcss.com  "></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Custom Styles -->
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        .strength-weak { width: 33%; background-color: #ef4444; }
        .strength-fair { width: 66%; background-color: #f59e0b; }
        .strength-good { width: 100%; background-color: #3b82f6; }
        .strength-strong { width: 100%; background-color: #10b981; }
        
        /* Language toggle styles */
        .language-option {
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .language-option:hover {
            transform: translateY(-2px);
        }
        
        .language-option input[type="radio"]:checked + label {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .language-option input[type="radio"] {
            display: none;
        }
        
        .language-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            background: #ecfdf5;
            border: 2px solid #d1fae5;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 44px;
        }
        
        .language-option label:hover {
            background: #d1fae5;
            border-color: #a7f3d0;
        }

        /* Tooltip styles */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .info-icon {
            width: 14px;
            height: 14px;
            background-color: #e5e7eb;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            transition: all 0.2s ease;
            color: #6b7280;
            font-size: 10px;
            margin-left: 4px;
        }

        .info-icon:hover {
            background-color: #10b981;
            color: white;
            transform: scale(1.1);
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-4px);
            background-color: #1f2937;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 100;
            max-width: 200px;
            white-space: normal;
            text-align: center;
            line-height: 1.3;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 4px 4px 0 4px;
            border-color: #1f2937 transparent transparent transparent;
        }

        .tooltip-wrapper:hover .tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-8px);
        }
    </style>

    <!-- Main Content -->
    <div class="bg-gradient-to-br from-green-50 via-white to-emerald-50 min-h-screen flex items-center justify-center p-4 sm:p-6">
        <div class="w-full max-w-5xl">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">

                <!-- Left Section -->
                <section class="flex flex-col justify-center items-center lg:items-start text-center lg:text-left">
                    <div class="mb-6 lg:mb-8">
                        <img 
                            src="{% static 'Login/images/saflora.png' %}" 
                            alt="Saflora Logo"
                            class="w-20 h-20 sm:w-24 sm:h-24 lg:w-32 lg:h-32 mx-auto lg:mx-0"
                        />
                    </div>
                    
                    <div class="space-y-4 lg:space-y-6">
                        <p class="text-gray-700 text-sm sm:text-base leading-relaxed max-w-sm">
                            Eco-friendly powder floor cleaner crafted in Nepal. Gentle on floors, tough on dirt â€” Introducing a clean and fresh solution for your household.
                        </p>
                        
                        <div class="flex flex-wrap gap-2 justify-center lg:justify-start">
                            <span class="bg-white px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium text-emerald-700 shadow-sm">Affordable</span>
                            <span class="bg-white px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium text-emerald-700 shadow-sm">Cleaning Power</span>
                            <span class="bg-white px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium text-emerald-700 shadow-sm">Fresh Herbal Scent</span>
                        </div>
                    </div>
                </section>

                <!-- Right Section - Form -->
                <aside class="bg-white bg-opacity-90 backdrop-blur-sm rounded-2xl shadow-lg p-6 sm:p-8 lg:p-10 border border-emerald-100">
                    <h2 class="text-2xl sm:text-3xl font-bold text-emerald-600 mb-2">Create Account</h2>
                    <p class="text-gray-600 text-sm sm:text-base mb-6">Sign up to start managing orders, products, and more</p>

                    <form method="POST" autocomplete="on" novalidate class="space-y-4">
                        {% csrf_token %}
                        
                        <!-- Username -->
                        <div>
                            <label for="username" class="block text-xs font-semibold text-gray-700 mb-2">Username *</label>
                            <input
                                type="text"
                                id="username"
                                name="username"
                                placeholder="Enter username"
                                required
                                pattern="[\w@.+_-]+"
                                title="Username can only contain letters, numbers, and @/./+/-/_ characters."
                                class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                            />
                            <p class="text-xs text-gray-500 mt-1">Letters, numbers, and @/./+/-/_ only. 3-20 characters.</p>
                            <!-- Added error message container -->
                            <p id="usernameError" class="text-xs text-red-600 mt-1 hidden">Username can only contain letters, numbers, and @/./+/-/_ characters.</p>
                        </div>

                        <!-- First & Last Name -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="firstname" class="block text-xs font-semibold text-gray-700 mb-2">First Name *</label>
                                <input
                                    type="text"
                                    id="firstname"
                                    name="firstname"
                                    placeholder="First name"
                                    required
                                    class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                                />
                            </div>
                            <div>
                                <label for="lastname" class="block text-xs font-semibold text-gray-700 mb-2">Last Name *</label>
                                <input
                                    type="text"
                                    id="lastname"
                                    name="lastname"
                                    placeholder="Last name"
                                    required
                                    class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                                />
                            </div>
                        </div>

                        <!-- Contact & Address -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="contact" class="block text-xs font-semibold text-gray-700 mb-2">Contact Number *</label>
                                <input
                                    type="text"
                                    id="contact"
                                    name="contact"
                                    placeholder="10-digit number"
                                    maxlength="10"
                                    required
                                    class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                                />
                                <div class="flex items-center justify-between mt-1">
                                    <p class="text-xs text-gray-500">Exactly 10 digits</p>
                                    <span id="contactCount" class="text-xs font-medium text-gray-500">0/10</span>
                                </div>
                                <p id="contactError" class="text-xs text-red-600 mt-1 hidden"></p>
                            </div>
                            <div>
                                <label for="address" class="block text-xs font-semibold text-gray-700 mb-2">Address *</label>
                                <input
                                    type="text"
                                    id="address"
                                    name="address"
                                    placeholder="Street address"
                                    required
                                    class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                                />
                            </div>
                        </div>

                        <!-- Email -->
                        <div>
                            <label for="email" class="block text-xs font-semibold text-gray-700 mb-2">Email Address *</label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                placeholder="your.email@example.com"
                                required
                                class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                            />
                            <p id="emailError" class="text-xs text-red-600 mt-1 hidden"></p>
                        </div>

                        <!-- Password -->
                        <div>
                            <label for="password" class="block text-xs font-semibold text-gray-700 mb-2">Password *</label>
                            <div class="relative">
                                <input
                                    type="password"
                                    id="password"
                                    name="password"
                                    placeholder="Create a strong password"
                                    required
                                    minlength="8"
                                    class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition pr-10"
                                />
                                <button 
                                    type="button" 
                                    id="togglePassword"
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-emerald-600 focus:outline-none"
                                >
                                    <!-- Eye Icon (Show) -->
                                    <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    <!-- Eye Off Icon (Hide) - Hidden by default -->
                                    <svg id="eyeOffIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Password Strength Indicator -->
                            <div class="mt-3 space-y-2">
                                <div class="flex gap-1">
                                    <div id="strengthBar" class="h-2 bg-gray-200 rounded-full flex-grow"></div>
                                </div>
                                <p id="strengthText" class="text-xs font-medium text-gray-600">Password strength: Not checked</p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li id="requirement-length" class="flex items-center gap-2">
                                        <span id="icon-length" class="text-gray-400">âœ“</span> At least 8 characters
                                    </li>
                                    <li id="requirement-upper" class="flex items-center gap-2">
                                        <span id="icon-upper" class="text-gray-400">âœ“</span> One uppercase letter
                                    </li>
                                    <li id="requirement-lower" class="flex items-center gap-2">
                                        <span id="icon-lower" class="text-gray-400">âœ“</span> One lowercase letter
                                    </li>
                                    <li id="requirement-number" class="flex items-center gap-2">
                                        <span id="icon-number" class="text-gray-400">âœ“</span> One number
                                    </li>
                                    <li id="requirement-special" class="flex items-center gap-2">
                                        <span id="icon-special" class="text-gray-400">âœ“</span> One special character (@$!%*?&)
                                    </li>
                                </ul>
                            </div>
                            <p id="passwordError" class="text-xs text-red-600 mt-2 hidden"></p>
                        </div>

                        <!-- Preferred Language -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-2">
                                Preferred Language *
                                <span class="tooltip-wrapper">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip">We'll use this language for emails and notifications</span>
                                </span>
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="language-option">
                                    <input 
                                        type="radio" 
                                        id="lang-english" 
                                        name="preferred_language" 
                                        value="en" 
                                        checked
                                        required
                                    />
                                    <label for="lang-english">
                                        <span>ðŸ‡¬ðŸ‡§ English</span>
                                    </label>
                                </div>
                                <div class="language-option">
                                    <input 
                                        type="radio" 
                                        id="lang-nepali" 
                                        name="preferred_language" 
                                        value="ne"
                                        required
                                    />
                                    <label for="lang-nepali">
                                        <span>ðŸ‡³ðŸ‡µ à¤¨à¥‡à¤ªà¤¾à¤²à¥€</span>
                                    </label>
                                </div>
                            </div>
                            <p id="languageError" class="text-xs text-red-600 mt-1 hidden">Please select a language preference.</p>
                        </div>

                        <!-- Referral -->
                        <div>
                            <label for="referral" class="block text-xs font-semibold text-gray-700 mb-2">How did you hear about us? *</label>
                            <select
                                id="referral"
                                name="referral"
                                required
                                class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                            >
                                <option value="" disabled selected>Select an option</option>
                                <option value="friend">Friend</option>
                                <option value="social">Social Media</option>
                                <option value="ad">Advertisement</option>
                                <option value="other">Other</option>
                            </select>
                            <!-- Added error message container -->
                            <p id="referralError" class="text-xs text-red-600 mt-1 hidden">Please select an option.</p>
                        </div>

                        <!-- Referral Other -->
                        <div id="referralOtherDiv" class="hidden">
                            <label for="referralOther" class="block text-xs font-semibold text-gray-700 mb-2">Please specify *</label>
                            <input
                                type="text"
                                id="referralOther"
                                name="referralOther"
                                placeholder="Tell us where you heard about us"
                                class="w-full px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-lg text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                            />
                        </div>

                        <!-- Submit Button -->
                        <button
                            type="submit"
                            class="w-full mt-6 px-6 py-3 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl hover:from-emerald-700 hover:to-teal-700 transition transform hover:scale-105 active:scale-95"
                        >
                            Create Account
                        </button>

                        <!-- Login Link -->
                        <div class="text-center text-sm text-gray-600 mt-4">
                            Already have an account?
                            <a href='{% url "login:user_login" %}' class="text-emerald-600 font-semibold hover:text-emerald-700 transition">
                                Log In
                            </a>
                        </div>
                    </form>
                </aside>
            </div>
        </div>
    </div>

    <!-- Validation & Real-time Feedback Script -->
    <script>
        // Contact Number Validation (existing code)
        const contactInput = document.getElementById('contact');
        const contactCount = document.getElementById('contactCount');
        const contactError = document.getElementById('contactError');

        contactInput.addEventListener('input', function(e) {
            // Only allow digits
            this.value = this.value.replace(/\D/g, '');
            
            // Update counter
            contactCount.textContent = `${this.value.length}/10`;
            
            // Validate length
            if (this.value.length === 10) {
                contactInput.classList.remove('border-red-400');
                contactInput.classList.add('border-green-400', 'ring-2', 'ring-green-400', 'ring-opacity-50');
                contactError.classList.add('hidden');
            } else if (this.value.length > 0) {
                contactInput.classList.remove('border-green-400', 'ring-2', 'ring-green-400', 'ring-opacity-50');
                contactInput.classList.add('border-red-400');
                contactError.textContent = `Must be exactly 10 digits (${10 - this.value.length} remaining)`;
                contactError.classList.remove('hidden');
            } else {
                contactInput.classList.remove('border-green-400', 'border-red-400', 'ring-2', 'ring-green-400', 'ring-opacity-50');
                contactError.classList.add('hidden');
            }
        });

        // Email Validation (existing code)
        const emailInput = document.getElementById('email');
        const emailError = document.getElementById('emailError');

        emailInput.addEventListener('blur', function() {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (this.value && !emailRegex.test(this.value)) {
                emailInput.classList.add('border-red-400');
                emailError.textContent = 'Please enter a valid email address';
                emailError.classList.remove('hidden');
            } else {
                emailInput.classList.remove('border-red-400');
                emailError.classList.add('hidden');
            }
        });

        emailInput.addEventListener('input', function() {
            if (this.value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(this.value)) {
                    emailInput.classList.remove('border-red-400');
                    emailInput.classList.add('border-green-400');
                    emailError.classList.add('hidden');
                }
            }
        });

        // Username Validation (existing code)
        const usernameInput = document.getElementById('username');
        const usernameError = document.getElementById('usernameError');
        const usernameRegex = /^[\w@.+_-]+$/; // Define regex once for reuse

        usernameInput.addEventListener('input', function() {
            const usernameValue = this.value;

            if (usernameValue === '') {
                // If empty, remove any validation colors and hide error
                usernameInput.classList.remove('border-red-400', 'border-green-400', 'ring-2', 'ring-green-400', 'ring-opacity-50');
                usernameError.classList.add('hidden');
            } else if (usernameRegex.test(usernameValue)) {
                // Valid: remove red, add green, hide error
                usernameInput.classList.remove('border-red-400');
                usernameInput.classList.add('border-green-400', 'ring-2', 'ring-green-400', 'ring-opacity-50');
                usernameError.classList.add('hidden');
            } else {
                // Invalid: remove green, add red, show error
                usernameInput.classList.remove('border-green-400', 'ring-2', 'ring-green-400', 'ring-opacity-50');
                usernameInput.classList.add('border-red-400');
                usernameError.classList.remove('hidden');
            }
        });

        // Password Strength Validation (existing code)
        const passwordInput = document.getElementById('password');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        const passwordError = document.getElementById('passwordError');

        const requirements = {
            'length': { regex: /.{8,}/, icon: 'icon-length', text: 'At least 8 characters' },
            'upper': { regex: /[A-Z]/, icon: 'icon-upper', text: 'One uppercase letter' },
            'lower': { regex: /[a-z]/, icon: 'icon-lower', text: 'One lowercase letter' },
            'number': { regex: /\d/, icon: 'icon-number', text: 'One number' },
            'special': { regex: /[@$!%*?&]/, icon: 'icon-special', text: 'One special character' }
        };

        function updatePasswordStrength() {
            const password = passwordInput.value;
            let metRequirements = 0;

            // Check each requirement
            Object.keys(requirements).forEach(key => {
                const requirement = requirements[key];
                const isMet = requirement.regex.test(password);
                const icon = document.getElementById(requirement.icon);
                const reqElement = document.getElementById(`requirement-${key}`);

                if (isMet) {
                    metRequirements++;
                    icon.textContent = 'âœ“';
                    icon.className = 'text-green-600 font-bold';
                    reqElement.classList.add('text-green-700');
                    reqElement.classList.remove('text-gray-600');
                } else {
                    icon.textContent = 'âœ—';
                    icon.className = 'text-red-400';
                    reqElement.classList.remove('text-green-700');
                    reqElement.classList.add('text-gray-600');
                }
            });

            // Update strength bar and text
            strengthBar.innerHTML = '';
            let strength = 'Weak';
            let strengthClass = 'strength-weak';

            if (metRequirements === 5) {
                strength = 'Strong';
                strengthClass = 'strength-strong';
            } else if (metRequirements === 4) {
                strength = 'Good';
                strengthClass = 'strength-good';
            } else if (metRequirements >= 2) {
                strength = 'Fair';
                strengthClass = 'strength-fair';
            }

            const bar = document.createElement('div');
            bar.className = `${strengthClass} h-full rounded-full transition-all duration-300`;
            strengthBar.appendChild(bar);

            strengthText.textContent = password ? `Password strength: ${strength}` : 'Password strength: Not checked';

            // Show error if weak
            if (password && metRequirements < 5) {
                passwordError.classList.add('hidden');
            } else if (metRequirements === 5) {
                passwordError.classList.add('hidden');
            }
        }

        passwordInput.addEventListener('input', updatePasswordStrength);

        // Toggle Password Visibility
        const togglePasswordBtn = document.getElementById('togglePassword');
        const eyeIcon = document.getElementById('eyeIcon');
        const eyeOffIcon = document.getElementById('eyeOffIcon');

        togglePasswordBtn.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            // Toggle icons
            if (type === 'text') {
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        });

        // Language selection animation
        const languageOptions = document.querySelectorAll('input[name="preferred_language"]');
        languageOptions.forEach(option => {
            option.addEventListener('change', function() {
                // Add a subtle animation when language is changed
                const label = this.nextElementSibling;
                label.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    label.style.transform = 'scale(1)';
                }, 100);
            });
        });

        // Referral "Other" field visibility (existing code)
        const referralSelect = document.getElementById('referral');
        const referralOtherDiv = document.getElementById('referralOtherDiv');
        const referralOtherInput = document.getElementById('referralOther');
        const referralError = document.getElementById('referralError'); // NEW: Reference to referral error

        referralSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                referralOtherDiv.classList.remove('hidden');
                referralOtherInput.required = true;
            } else {
                referralOtherDiv.classList.add('hidden');
                referralOtherInput.required = false;
                referralOtherInput.value = '';
            }
            // NEW: Clear error when user makes a selection
            if (this.value !== '') {
                referralSelect.classList.remove('border-red-400');
                referralError.classList.add('hidden');
            }
        });

        // Form Validation on Submit (updated to include username, referral, and language)
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            let isValid = true;

            // Validate contact
            if (contactInput.value.length !== 10) {
                contactInput.classList.add('border-red-400');
                contactError.textContent = 'Contact number must be exactly 10 digits';
                contactError.classList.remove('hidden');
                isValid = false;
            }

            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailInput.value)) {
                emailInput.classList.add('border-red-400');
                emailError.textContent = 'Please enter a valid email address';
                emailError.classList.remove('hidden');
                isValid = false;
            }

            // Validate username pattern (existing code)
            if (!usernameRegex.test(usernameInput.value)) {
                usernameInput.classList.add('border-red-400');
                usernameError.classList.remove('hidden'); // Show error message
                isValid = false;
            }

            // Validate password strength (existing code)
            let metRequirements = 0;
            Object.keys(requirements).forEach(key => {
                if (requirements[key].regex.test(passwordInput.value)) {
                    metRequirements++;
                }
            });

            if (metRequirements < 5) {
                passwordInput.classList.add('border-red-400');
                passwordError.textContent = 'Password does not meet all requirements';
                passwordError.classList.remove('hidden');
                isValid = false;
            }

            // Validate language selection
            const selectedLanguage = document.querySelector('input[name="preferred_language"]:checked');
            const languageError = document.getElementById('languageError');
            if (!selectedLanguage) {
                languageError.classList.remove('hidden');
                isValid = false;
            } else {
                languageError.classList.add('hidden');
            }

            // NEW: Validate referral selection
            if (referralSelect.value === '') {
                referralSelect.classList.add('border-red-400');
                referralError.classList.remove('hidden'); // Show error message
                isValid = false;
            }

            if (!isValid) {
                e.preventDefault();
            }
        });
    </script>
{% endblock content %}