
{% extends "Home/base/navbar.html" %}
{% block title %} Check-Out{% endblock title %}
{% block content %} 
{% load static %}
{% comment %} {% load static tailwind_tags %}
{% tailwind_css %} {% endcomment %}

<head>
  <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
<link rel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"/>
<link rel="stylesheet" href="{% static 'css/check_out/check_out.css' %}">
</head>
    
<div class="container">

      <!-- Main Content -->
      <main class="main-content">
        <div class="checkout-container">
          <!-- Left Side: Product Details -->
          <div class="product-details-section">
            <img
              src="{% if product.image %} {{product.image.url}}{% endif %}"
              alt="Product Image"
              class="product-image"
              id="buy-product-image"
            />
            <h1 class="product-name" id="buy-product-name">{{product.name}}</h1>
            <div class="product-price" id="buy-product-price"> NPR {% if product.discount_price %} {{product.discount_price}} {% else %} {{product.price}} {% endif %}/Unit</div>
            <p class="product-description" id="buy-product-description">
              {{product.description}}
            </p>
          </div>

          <!-- Right Side: Purchase Form -->
          <form class="purchase-form" onsubmit="return false;">
            <!-- Fragrance -->
            <div>
              <h3 class="form-section-title">1. Select Fragrance</h3>
              <div class="fragrance-selector">
                <button
                  type="button"
                  class="fragrance-btn"
                  data-fragrance="lemon"
                >
                  <i class="fas fa-leaf"></i> Lemon
                </button>
                <button
                  type="button"
                  class="fragrance-btn"
                  data-fragrance="jasmine"
                >
                  <i class="fas fa-spa"></i> Jasmine
                </button>
              </div>
            </div>

            <!-- Quantity -->
            <div>
              <h3 class="form-section-title">2. Choose Quantity</h3>
              <div class="quantity-selector">
                <button type="button" class="quantity-btn" id="decrease-qty">
                  -
                </button>
                <input id="quantity-input" value="1" min="1" readonly />
                <button type="button" class="quantity-btn" id="increase-qty">
                  +
                </button>
              </div>
            </div>

            <!-- Total Price -->
            <div class="total-price-section">
              <span>Item Total:</span>
              <span id="total-price">NPR 0</span>
            </div>

            <!-- Add to cart and cart summary -->
            <div>
              <button
                type="button"
                class="add-to-cart-btn"
                id="add-to-cart-btn"
              >
                <i class="fas fa-cart-plus"></i> Add to Cart
              </button>
              <div class="cart-summary" id="cart-summary"></div>
            </div>

            <!-- Payment Method -->
            <div>
              <h3 class="form-section-title">3. Payment Method</h3>
              <div class="payment-options">
                <label class="payment-option" id="khalti-option">
                  <input
                    type="radio"
                    name="payment_method"
                    value="khalti"
                    checked
                  />
                  <img src="{% static 'assets/icons/khalti.png' %}" alt="Khalti" />
                  <div class="payment-option-details">
                    <span class="name">Khalti Wallet</span>
                  </div>
                </label>
                <label class="payment-option" id="cod-option">
                  <input type="radio" name="payment_method" value="cod" />
                  <img src="{% static 'assets/icons/COD.png' %}" alt="Cash on Delivery" />
                  <div class="payment-option-details">
                    <span class="name">Cash on Delivery</span>
                  </div>
                </label>
              </div>
            </div>

            <button type="button" class="buy-now-btn" id="confirm-purchase-btn">
              <i class="fas fa-lock"></i> Confirm Purchase
            </button>
          </form>
        </div>
      </main>
    </div>

    <!-- Toast Notification Element -->
    <div id="toast" class="toast-notification">Item added to cart!</div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- 1. PRODUCT DATABASE ---
        const productDatabase = {
          powder: {
            name: "Powdered Floor Cleaner",
            fragrances: {
              lemon: {
                price: 100,
                image: "img/lemon.jpg",
                description:
                  "Saflora’s Lemon Fragrance Powder Floor Cleaner combines powerful cleaning performance with the refreshing scent of lemon. Its unique powder formula removes dirt, grease, and stains effectively, leaving your floors spotless and bright. Lightweight, eco-friendly, and long-lasting, it’s the perfect choice for everyday cleaning.   ",
              },
              jasmine: {
                price: 100,
                image: "img/jasmine.jpg",
                description:
                  "Infused with the soothing aroma of jasmine, Saflora’s Jasmine Fragrance Powder Floor Cleaner keeps your home smelling pleasant while ensuring a hygienic, sparkling clean. Its powder-based formula makes it lightweight, cost-effective, and sustainable — a perfect choice for households that value freshness and purity.",
              },
            },
          },
          liquid: {
            name: "Liquid Floor Cleaner",
            fragrances: {
              lemon: {
                price: 100,
                image: "img/liqiud.jpg",
                description:
                  "Saflora’s Lemon Liquid Floor Cleaner delivers a quick, streak-free shine and a burst of lemon freshness that keeps your home smelling clean all day. Its powerful formula removes tough stains and kills germs, ensuring both cleanliness and hygiene in every swipe.",
              },
              jasmine: {
                price: 100,
                image: "img/liquid.png",
                description:
                  "Enjoy the luxurious scent of jasmine while keeping your floors spotless with Saflora’s Jasmine Liquid Floor Cleaner. Its advanced cleaning agents remove dust, dirt, and bacteria, leaving behind a lingering floral fragrance that transforms your space into a soothing haven.",
              },
            },
          },
        };

        // --- 2. GLOBAL STATE ---
        let cart = [];
        let currentProductType = null;
        let selectedFragrance = "lemon"; // Default fragrance

        // --- 3. DOM ELEMENTS ---
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get("product");
        currentProductType = productDatabase[productId];

        const elements = {
          image: document.getElementById("buy-product-image"),
          name: document.getElementById("buy-product-name"),
          price: document.getElementById("buy-product-price"),
          description: document.getElementById("buy-product-description"),
          quantityInput: document.getElementById("quantity-input"),
          decreaseBtn: document.getElementById("decrease-qty"),
          increaseBtn: document.getElementById("increase-qty"),
          totalPrice: document.getElementById("total-price"),
          fragranceBtns: document.querySelectorAll(".fragrance-btn"),
          addToCartBtn: document.getElementById("add-to-cart-btn"),
          confirmBtn: document.getElementById("confirm-purchase-btn"),
          cartSummary: document.getElementById("cart-summary"),
          toast: document.getElementById("toast"),
          paymentOptions: document.querySelectorAll(".payment-option"),
        };

        // --- 4. CORE FUNCTIONS ---
        function updateDisplay() {
          if (!currentProductType) return;
          const fragranceData =
            currentProductType.fragrances[selectedFragrance];

          elements.image.src = fragranceData.image;
          elements.name.textContent = `${currentProductType.name} (${
            selectedFragrance.charAt(0).toUpperCase() +
            selectedFragrance.slice(1)
          })`;
          elements.description.textContent = fragranceData.description;

          elements.fragranceBtns.forEach((btn) => {
            btn.classList.toggle(
              "active",
              btn.dataset.fragrance === selectedFragrance
            );
          });

          updateTotalPrice();
        }

        function updateTotalPrice() {
          if (!currentProductType) return;
          const quantity = parseInt(elements.quantityInput.value);
          const unitPrice =
            currentProductType.fragrances[selectedFragrance].price;
          const total = unitPrice * quantity;
          elements.price.textContent = `NPR ${unitPrice} / unit`;
          elements.totalPrice.textContent = `NPR ${total}`;
        }

        function updateCartSummary() {
          if (cart.length > 0) {
            const totalItems = cart.reduce(
              (sum, item) => sum + item.quantity,
              0
            );
            const cartTotal = cart.reduce(
              (sum, item) => sum + item.unitPrice * item.quantity,
              0
            );
            elements.cartSummary.innerHTML = `Your cart has ${totalItems} item(s). <br><strong>Cart Total: NPR ${cartTotal}</strong>`;
            elements.cartSummary.classList.add("visible");
          } else {
            elements.cartSummary.classList.remove("visible");
          }
        }

        function showToast(message) {
          elements.toast.textContent = message;
          elements.toast.classList.add("show");
          setTimeout(() => {
            elements.toast.classList.remove("show");
          }, 2500);
        }

        // --- 5. EVENT LISTENERS ---


        elements.fragranceBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            selectedFragrance = btn.dataset.fragrance;
            updateDisplay();
          });
        });

        elements.increaseBtn.addEventListener("click", () => {
          elements.quantityInput.value =
            parseInt(elements.quantityInput.value) + 1;
          updateTotalPrice();
        });
        elements.decreaseBtn.addEventListener("click", () => {
          let qty = parseInt(elements.quantityInput.value);
          if (qty > 1) {
            elements.quantityInput.value = qty - 1;
            updateTotalPrice();
          }
        });

        elements.addToCartBtn.addEventListener("click", () => {
          const item = {
            type: currentProductType.name,
            fragrance: selectedFragrance,
            quantity: parseInt(elements.quantityInput.value),
            unitPrice: currentProductType.fragrances[selectedFragrance].price,
          };
          cart.push(item);
          updateCartSummary();
          showToast("Item added to cart!");
          console.log("Cart contents:", cart); // For debugging
        });

        elements.paymentOptions.forEach((option) => {
          option.addEventListener("click", () => {
            elements.paymentOptions.forEach((opt) =>
              opt.classList.remove("selected")
            );
            option.classList.add("selected");
            option.querySelector('input[type="radio"]').checked = true;
          });
        });
        document.getElementById("khalti-option").classList.add("selected");

        elements.confirmBtn.addEventListener("click", () => {
          if (cart.length === 0) {
            showToast("Your cart is empty. Please add an item first.");
            return;
          }
          const selectedPayment = document.querySelector(
            'input[name="payment_method"]:checked'
          ).value;
          const purchaseDetails = {
            items: cart.map(
              (item) => `${item.quantity}x ${item.type} (${item.fragrance})`
            ),
            paymentMethod: selectedPayment,
            totalAmount: `NPR ${cart.reduce(
              (total, item) => total + item.unitPrice * item.quantity,
              0
            )}`,
          };

          alert(
            `Thank you for your order!\n\n--- ORDER SUMMARY ---\n${JSON.stringify(
              purchaseDetails,
              null,
              2
            )}\n\nThis data would now be sent to your server.`
          );

          cart = []; // Clear cart after purchase
          updateCartSummary();
        });

        // --- 6. INITIALIZE PAGE ---
        updateDisplay();
      });
    </script>
  </body>
{% endblock content %}